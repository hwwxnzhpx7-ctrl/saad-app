<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>i-System Pro | Al Rajhi Style</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --alrajhi-bg: #000000;
            --alrajhi-card: #151515;
            --alrajhi-blue: #0066ff;
            --alrajhi-light-blue: #5599ff;
            --alrajhi-text: #ffffff;
            --alrajhi-muted: #888888;
            --alrajhi-success: #27ae60;
            --alrajhi-danger: #eb5757;
            --alrajhi-mint: #d1fadc;
            --alrajhi-mint-text: #1e5631;
        }

        body { 
            background-color: var(--alrajhi-bg); 
            color: var(--alrajhi-text);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin-bottom: 100px;
        }

        /* تنسيق الرصيد الإجمالي */
        .total-balance-section {
            padding: 40px 20px;
            text-align: center;
        }

        .balance-label {
            color: var(--alrajhi-muted);
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .balance-amount {
            font-size: 2.2rem;
            font-weight: 700;
            font-family: 'Arial', sans-serif;
        }

        .balance-currency {
            font-size: 1.2rem;
            margin-right: 5px;
            color: var(--alrajhi-text);
        }

        /* البطاقات المستوحاة من صور الراجحي */
        .alrajhi-card {
            background: var(--alrajhi-card);
            border-radius: 18px;
            padding: 20px;
            margin-bottom: 15px;
            border: none;
        }

        .mini-stat-box {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 12px;
            height: 100%;
            text-align: right;
        }

        .mini-stat-label {
            color: var(--alrajhi-muted);
            font-size: 0.75rem;
            display: block;
        }

        .mini-stat-value {
            font-size: 1rem;
            font-weight: 600;
            margin-top: 4px;
        }

        /* أزرار العمليات */
        .btn-alrajhi-primary {
            background-color: var(--alrajhi-blue);
            color: white;
            border-radius: 12px;
            padding: 12px;
            font-weight: 600;
            border: none;
            width: 100%;
        }

        .btn-view-status {
            background: rgba(85, 153, 255, 0.1);
            color: var(--alrajhi-light-blue);
            border-radius: 50px;
            padding: 6px 20px;
            font-size: 0.85rem;
            border: none;
            margin-top: 15px;
        }

        /* شريط التنقل السفلي - نسخة الراجحي */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: #000000;
            display: flex; justify-content: space-around;
            padding: 10px 0 25px; 
            border-top: 1px solid #222;
            z-index: 1000;
        }

        .nav-item { color: var(--alrajhi-muted); text-decoration: none; text-align: center; flex: 1; font-size: 0.7rem; cursor: pointer; }
        .nav-item.active { color: var(--alrajhi-blue); }
        .nav-item i { font-size: 1.4rem; display: block; margin-bottom: 4px; }

        /* الأقساط */
        .installment-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #222;
        }

        .status-pill {
            padding: 4px 12px;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .paid-pill { background: var(--alrajhi-mint); color: var(--alrajhi-mint-text); }
        .unpaid-pill { background: rgba(235, 87, 87, 0.1); color: var(--alrajhi-danger); }

        .section-header {
            font-size: 1.1rem;
            font-weight: 700;
            margin: 25px 0 15px;
            display: flex;
            justify-content: space-between;
        }

        .form-control {
            background: #1a1a1a !important;
            border: 1px solid #333 !important;
            color: white !important;
            border-radius: 12px !important;
            padding: 12px !important;
        }
    </style>
</head>
<body>

<div id="loginPage" class="p-4 mt-5">
    <div class="text-center mb-5">
        <h3 class="fw-bold">دخول النظام</h3>
        <p class="text-secondary small">أدخل رمز الوصول الآمن</p>
    </div>
    <div class="alrajhi-card">
        <input type="password" id="passInput" class="form-control text-center mb-4 fs-3" placeholder="••••">
        <button onclick="login()" class="btn btn-alrajhi-primary">تسجيل الدخول</button>
    </div>
</div>

<div id="mainContent" style="display: none;">
    <section id="homeSection" class="p-3">
        <div class="total-balance-section">
            <div class="balance-label"><i class="bi bi-eye-slash-fill me-1"></i> الرصيد الإجمالي</div>
            <div class="balance-amount"><span class="balance-currency">﷼</span><span id="totalInvestment">0</span></div>
            <button class="btn btn-view-status">عرض الوضع المالي <i class="bi bi-bar-chart-fill ms-1"></i></button>
        </div>

        <div class="section-header">الحسابات <span class="text-primary small fw-normal">عرض الكل</span></div>
        
        <div class="row g-2 mb-4">
            <div class="col-6"><div class="mini-stat-box"><span class="mini-stat-label">المحصل</span><div class="mini-stat-value text-success" id="statCollected">0</div></div></div>
            <div class="col-6"><div class="mini-stat-box"><span class="mini-stat-label">الأرباح</span><div class="mini-stat-value text-warning" id="statRealProfit">0</div></div></div>
            <div class="col-6"><div class="mini-stat-box"><span class="mini-stat-label">المتبقي</span><div class="mini-stat-value text-danger" id="statRemaining">0</div></div></div>
            <div class="col-6"><div class="mini-stat-box"><span class="mini-stat-label">المتعثرين</span><div class="mini-stat-value" id="statLateCount">0</div></div></div>
        </div>

        <div class="section-header">الطلبات <span class="text-primary small fw-normal" onclick="toggleLateFilter()" id="filterLateBtn">تصفية المتأخرين</span></div>
        <div id="clientsList"></div>
    </section>

    <section id="addClientSection" class="p-3" style="display:none;">
        <h5 class="fw-bold mb-4">فتح ملف استثماري</h5>
        <div class="alrajhi-card">
            <form id="clientForm">
                <input type="text" id="cName" class="form-control mb-3" placeholder="الاسم الكامل" required>
                <div class="row g-2 mb-3">
                    <div class="col-6"><input type="text" id="cID" class="form-control" placeholder="رقم الهوية"></div>
                    <div class="col-6"><input type="text" id="cPhone" class="form-control" placeholder="الجوال"></div>
                </div>
                <div class="row g-2 mb-3">
                    <div class="col-6"><input type="number" id="costAmount" class="form-control" placeholder="التكلفة"></div>
                    <div class="col-6"><input type="number" id="amount" class="form-control" placeholder="مبلغ البيع"></div>
                </div>
                <div class="row g-2 mb-3">
                    <div class="col-6"><input type="number" id="instCount" class="form-control" placeholder="عدد الأشهر"></div>
                    <div class="col-6"><input type="date" id="startDate" class="form-control"></div>
                </div>
                <button type="submit" class="btn btn-alrajhi-primary mt-3">اعتماد العقد</button>
            </form>
        </div>
    </section>

    <section id="detailsSection" class="p-3" style="display:none;">
        <div class="d-flex align-items-center mb-4">
            <i class="bi bi-arrow-right fs-4 me-3" onclick="showSection('home')"></i>
            <h5 class="fw-bold mb-0">تفاصيل العقد</h5>
        </div>
        <div id="pdfArea"><div id="clientDetailsContent"></div></div>
    </section>

    <div class="bottom-nav">
        <div class="nav-item active" id="nav-home" onclick="showSection('home')"><i class="bi bi-house-door"></i>الرئيسية</div>
        <div class="nav-item" id="nav-add" onclick="showSection('addClient')"><i class="bi bi-plus-square"></i>إضافة</div>
        <div class="nav-item" id="nav-settings" onclick="logout()"><i class="bi bi-box-arrow-right"></i>خروج</div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCsF-OsbE075c0lwhhcOj6GIHdUZAfCHCU",
        authDomain: "myinstallmentsystem.firebaseapp.com",
        projectId: "myinstallmentsystem",
        storageBucket: "myinstallmentsystem.firebasestorage.app",
        messagingSenderId: "1073933519716",
        appId: "1:1073933519716:web:caac200c07e0356f81c871"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const clientsCol = collection(db, "clients");

    let clients = [];
    let systemPass = localStorage.getItem('systemPass') || '1955';
    let showOnlyLate = false;

    window.login = () => {
        if (document.getElementById('passInput').value === systemPass) {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            startListening();
        } else { alert('خطأ في الرمز'); }
    }

    function startListening() {
        onSnapshot(clientsCol, (snapshot) => {
            clients = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderHome();
        });
    }

    window.toggleLateFilter = () => {
        showOnlyLate = !showOnlyLate;
        document.getElementById('filterLateBtn').innerText = showOnlyLate ? "عرض الكل" : "تصفية المتأخرين";
        renderHome();
    };

    window.showSection = (id) => {
        ['homeSection', 'addClientSection', 'detailsSection'].forEach(s => document.getElementById(s).style.display = 'none');
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        document.getElementById(id + 'Section').style.display = 'block';
        document.getElementById('nav-' + (id === 'details' ? 'home' : id)).classList.add('active');
        if(id === 'home') renderHome();
    }

    document.getElementById('clientForm').onsubmit = async function(e) {
        e.preventDefault();
        const cost = parseFloat(document.getElementById('costAmount').value);
        const amount = parseFloat(document.getElementById('amount').value);
        const count = parseInt(document.getElementById('instCount').value);
        const date = new Date(document.getElementById('startDate').value);
        let installments = [];
        for(let i=0; i<count; i++) {
            let d = new Date(date); d.setMonth(d.getMonth() + i);
            installments.push({ dueDate: d.toISOString().split('T')[0], amount: (amount / count).toFixed(2), status: 'غير مدفوع' });
        }
        await addDoc(clientsCol, {
            name: document.getElementById('cName').value, idNum: document.getElementById('cID').value,
            phone: document.getElementById('cPhone').value, cost: cost, total: amount, installments: installments
        });
        this.reset(); showSection('home');
    };

    function renderHome() {
        const list = document.getElementById('clientsList');
        list.innerHTML = '';
        let totalSales = 0, collected = 0, totalCost = 0, lateCount = 0;
        const today = new Date().toISOString().split('T')[0];

        clients.forEach(c => {
            let hasLate = false, clientPaid = 0;
            c.installments.forEach(inst => {
                if(inst.status === 'مدفوع') { collected += parseFloat(inst.amount); clientPaid += parseFloat(inst.amount); }
                else if (inst.dueDate < today) hasLate = true;
            });
            if(hasLate) lateCount++;
            if(showOnlyLate && !hasLate) return;
            totalSales += parseFloat(c.total); totalCost += parseFloat(c.cost || 0);

            list.innerHTML += `
                <div class="alrajhi-card d-flex justify-content-between align-items-center">
                    <div>
                        <div class="fw-bold mb-1">${c.name}</div>
                        <div class="small text-secondary">الباقي: ${(c.total - clientPaid).toLocaleString()} ﷼</div>
                    </div>
                    <div class="d-flex gap-3">
                        <i class="bi bi-chevron-left text-secondary" onclick="viewClient('${c.id}')"></i>
                        <i class="bi bi-trash3 text-danger opacity-50" onclick="deleteClient('${c.id}')"></i>
                    </div>
                </div>`;
        });
        document.getElementById('totalInvestment').innerText = totalSales.toLocaleString();
        document.getElementById('statCollected').innerText = collected.toLocaleString();
        document.getElementById('statRemaining').innerText = (totalSales - collected).toLocaleString();
        document.getElementById('statLateCount').innerText = lateCount;
        document.getElementById('statRealProfit').innerText = (collected > totalCost ? collected - totalCost : 0).toLocaleString();
    }

    window.viewClient = (id) => {
        const client = clients.find(c => c.id === id);
        let html = `<div class="alrajhi-card">
            <h5 class="fw-bold">${client.name}</h5>
            <div class="small text-secondary mb-3">${client.phone} | ${client.idNum}</div>
            <div class="mt-4">`;
        
        client.installments.forEach((inst, idx) => {
            const isPaid = inst.status === 'مدفوع';
            html += `
                <div class="installment-row" onclick="togglePayment('${id}', ${idx})">
                    <div>
                        <div class="small text-secondary">${inst.dueDate}</div>
                        <div class="fw-bold mt-1">${parseFloat(inst.amount).toLocaleString()} ﷼</div>
                    </div>
                    <span class="status-pill ${isPaid ? 'paid-pill' : 'unpaid-pill'}">${inst.status}</span>
                </div>`;
        });
        document.getElementById('clientDetailsContent').innerHTML = html + `</div></div><button class="btn btn-light w-100 mt-3" onclick="downloadPDF()">تحميل PDF</button>`;
        showSection('details');
    };

    window.togglePayment = async (id, idx) => {
        const c = clients.find(x => x.id === id);
        c.installments[idx].status = c.installments[idx].status === 'مدفوع' ? 'غير مدفوع' : 'مدفوع';
        await updateDoc(doc(db, "clients", id), { installments: c.installments });
        viewClient(id);
    };

    window.deleteClient = async (id) => { if(confirm("حذف العميل نهائياً؟")) await deleteDoc(doc(db, "clients", id)); };
    window.downloadPDF = () => { html2pdf().from(document.getElementById('pdfArea')).save('Statement.pdf'); };
    window.logout = () => location.reload();
</script>
</body>
</html>
