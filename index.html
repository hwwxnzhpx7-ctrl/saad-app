<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>i-System Pro | التقسيط الذكي</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        :root { --bg-dark: #0f1217; --card-bg: #1c2128; --accent-orange: #ff6b35; --text-main: #ffffff; }
        body { background-color: var(--bg-dark); color: var(--text-main); font-family: 'Segoe UI', sans-serif; }
        .stat-card { background: var(--card-bg); border-radius: 20px; padding: 25px; border: 1px solid rgba(255,255,255,0.1); }
        .btn-action { background: var(--accent-orange); color: white; border-radius: 15px; padding: 15px; width: 100%; border: none; font-weight: bold; }
        .form-control { background: #24292f !important; border: 1px solid #3d444d !important; color: white !important; border-radius: 12px; padding: 12px; }
    </style>
</head>
<body>

<div id="loginPage" class="container mt-5">
    <div class="stat-card text-center shadow-lg">
        <h4 class="fw-bold mb-4">دخول i-System</h4>
        <div id="phoneArea">
            <input type="text" id="phoneInput" class="form-control text-center mb-3 fs-5" placeholder="0534152055">
            <button id="sendBtn" class="btn btn-action">تحقق من الرقم</button>
            <div id="recaptcha-container" class="mt-3"></div>
        </div>
        <div id="otpArea" style="display: none;">
            <input type="text" id="otpInput" class="form-control text-center mb-3 fs-4" placeholder="••••••">
            <button id="verifyBtn" class="btn btn-action">تأكيد الدخول</button>
        </div>
    </div>
</div>

<div id="mainContent" style="display: none;" class="p-3">
    <div class="stat-card text-center mb-4">
        <h6>إجمالي المحفظة</h6>
        <h2 id="totalInvestment" class="fw-bold text-orange">0</h2>
    </div>
    <div id="clientsList"></div>
    <button onclick="logout()" class="btn btn-outline-danger w-100 mt-4">خروج</button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getAuth, RecaptchaVerifier, signInWithPhoneNumber, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
    import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCsF-OsbE075c0lwhhcOj6GIHdUZAfCHCU",
        authDomain: "myinstallmentsystem.firebaseapp.com",
        projectId: "myinstallmentsystem",
        storageBucket: "myinstallmentsystem.firebasestorage.app",
        messagingSenderId: "1073933519716",
        appId: "1:1073933519716:web:caac200c07e0356f81c871"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const ADMIN_PHONE = "+966534152055";

    // ربط الأزرار برمجياً بدلاً من onclick العادي لتجنب مشاكل المتصفح
    document.getElementById('sendBtn').addEventListener('click', sendOTP);
    document.getElementById('verifyBtn').addEventListener('click', verifyOTP);

    function setupRecaptcha() {
        if (!window.recaptchaVerifier) {
            window.recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', { 'size': 'invisible' });
        }
    }

    async function sendOTP() {
        let phone = document.getElementById('phoneInput').value.trim();
        // تصحيح الرقم تلقائياً
        if(phone.startsWith('05')) phone = '+966' + phone.substring(1);
        else if(!phone.startsWith('+')) phone = '+966' + phone;

        if (phone !== ADMIN_PHONE) {
            alert("هذا الرقم غير مصرح له بالدخول");
            return;
        }

        setupRecaptcha();
        try {
            const confirmationResult = await signInWithPhoneNumber(auth, phone, window.recaptchaVerifier);
            window.confirmationResult = confirmationResult;
            document.getElementById('phoneArea').style.display = 'none';
            document.getElementById('otpArea').style.display = 'block';
            alert("تم إرسال الكود أو استخدم كود الاختبار");
        } catch (error) {
            alert("خطأ: " + error.message);
        }
    }

    async function verifyOTP() {
        const code = document.getElementById('otpInput').value;
        try {
            await window.confirmationResult.confirm(code);
        } catch (error) {
            alert("الرمز غير صحيح");
        }
    }

    onAuthStateChanged(auth, (user) => {
        if (user && user.phoneNumber === ADMIN_PHONE) {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            loadData();
        } else {
            document.getElementById('loginPage').style.display = 'block';
            document.getElementById('mainContent').style.display = 'none';
        }
    });

    function loadData() {
        onSnapshot(collection(db, "clients"), (snap) => {
            let total = 0;
            const list = document.getElementById('clientsList');
            list.innerHTML = '';
            snap.forEach(doc => {
                const c = doc.data();
                total += parseFloat(c.total || 0);
                list.innerHTML += `<div class="stat-card mb-2 d-flex justify-content-between"><span>${c.name}</span><b>${c.total}</b></div>`;
            });
            document.getElementById('totalInvestment').innerText = total.toLocaleString() + ' ر.س';
        });
    }

    window.logout = () => signOut(auth).then(() => location.reload());
</script>
</body>
</html>
