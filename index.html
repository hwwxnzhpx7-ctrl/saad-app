<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCsF-OsbE075c0lwhhcOj6GIHdUZAfCHCU",
        authDomain: "myinstallmentsystem.firebaseapp.com",
        projectId: "myinstallmentsystem",
        appId: "1:1073933519716:web:caac200c07e0356f81c871"
    };
    
    firebase.initializeApp(firebaseConfig);

    // استخدام reCAPTCHA المرئي (أكثر أماناً لضمان وصول الرسالة)
    window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
        'size': 'normal', // سيظهر مربع "أنا لست برنامج روبوت"
        'callback': (response) => {
            console.log("تم التحقق من البشر بنجاح");
        }
    });

    function handleSendOTP() {
        let phoneNumber = document.getElementById('phone-input').value.trim();
        
        // تنسيق الرقم دولياً
        if(phoneNumber.startsWith('0')) phoneNumber = '+966' + phoneNumber.substring(1);
        
        const appVerifier = window.recaptchaVerifier;

        firebase.auth().signInWithPhoneNumber(phoneNumber, appVerifier)
            .then((confirmationResult) => {
                window.confirmationResult = confirmationResult;
                document.getElementById('phone-stage').style.display = 'none';
                document.getElementById('otp-stage').style.display = 'block';
                alert("انتظر وصول الرسالة على جوالك الآن...");
            }).catch((error) => {
                console.error("خطأ الإرسال:", error.code);
                if(error.code === 'auth/billing-not-enabled') {
                    alert("تنبيه: جوجل ترفض الإرسال حالياً. تأكد من إضافة رابط موقعك في Authorized Domains داخل Firebase.");
                } else {
                    alert("حدث خطأ: " + error.message);
                }
            });
    }

    function handleVerifyOTP() {
        const code = document.getElementById('otp-input').value;
        window.confirmationResult.confirm(code)
            .then((result) => {
                alert("تم الدخول بنجاح!");
                // هنا تضع كود عرض البرنامج الرئيسي
                document.getElementById('auth-ui').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
            }).catch((error) => {
                alert("الرمز الذي أدخلته غير صحيح");
            });
    }
</script>
