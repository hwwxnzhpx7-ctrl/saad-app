<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تقسيط سعد | النظام السحابي الموثق</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --bg-dark: #0f1217; --card-bg: #1c2128; --accent-orange: #ff6b35; 
            --text-main: #ffffff; --text-dim: #e0e0e0; --success-green: #2ecc71; --error-red: #e74c3c;
        }
        body { background-color: var(--bg-dark); color: var(--text-main); font-family: 'Segoe UI', sans-serif; margin-bottom: 90px; }
        .stat-card { background: var(--card-bg); border-radius: 20px; padding: 25px; border: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; }
        .form-control { background: #24292f !important; border: 1px solid #3d444d !important; border-radius: 12px !important; color: #ffffff !important; padding: 12px !important; }
        .btn-action { background: var(--accent-orange); color: white; border: none; border-radius: 15px; padding: 15px; font-weight: bold; width: 100%; }
        .btn-google { background: #ffffff; color: #000000; border-radius: 15px; padding: 12px; font-weight: bold; width: 100%; border: none; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-email { background: rgba(255,255,255,0.05); color: white; border: 1px solid rgba(255,255,255,0.2); border-radius: 15px; padding: 12px; width: 100%; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(28, 33, 40, 0.98); display: flex; padding: 12px 0; border-top: 1px solid rgba(255,255,255,0.1); z-index: 1000; }
        .nav-item { color: #8b949e; text-align: center; flex: 1; cursor: pointer; font-size: 0.8rem; }
        .nav-item.active { color: var(--accent-orange); font-weight: bold; }
        .client-row { background: #24292f; border-radius: 15px; margin-bottom: 12px; padding: 18px; display: flex; justify-content: space-between; align-items: center; border: 1px solid rgba(255,255,255,0.05); }
        .section-title { color: var(--accent-orange); border-right: 4px solid var(--accent-orange); padding-right: 12px; margin: 20px 0 15px; font-weight: bold; }
    </style>
</head>
<body>

<div id="loginPage" class="p-4 mt-5">
    <div class="stat-card text-center shadow-lg">
        <div style="background: var(--accent-orange); width: 60px; height: 60px; border-radius: 20px; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
            <i class="bi bi-shield-check text-white fs-2"></i>
        </div>
        <h4 class="fw-bold mb-4">تقسيط سعد السحابي</h4>
        
        <button onclick="loginWithGoogle()" class="btn btn-google">
            <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" width="20">
            الدخول عبر Google
        </button>

        <div class="my-3 text-dim">أو</div>

        <input type="email" id="userEmail" class="form-control mb-2 text-center" placeholder="البريد الإلكتروني">
        <input type="password" id="userPass" class="form-control mb-3 text-center" placeholder="كلمة المرور">
        <button onclick="loginWithEmail()" class="btn btn-email mb-2">تسجيل الدخول</button>
    </div>
</div>

<div id="mainContent" style="display: none;">
    <section id="homeSection" class="p-3">
        <div class="stat-card text-center">
            <label class="text-dim">إجمالي مبيعات تقسيط سعد</label>
            <h1 class="fw-bold my-2" id="totalInvestment">0</h1>
            <div class="badge bg-dark p-2 mt-2" style="color: var(--accent-orange);">العملاء: <span id="clientsCount">0</span></div>
        </div>
        <div id="clientsList"></div>
    </section>

    <section id="addClientSection" class="p-3" style="display:none;">
        <h5 class="fw-bold mb-3">فتح ملف استثماري</h5>
        <div class="stat-card">
            <form id="clientForm">
                <div class="section-title">بيانات العميل</div>
                <input type="text" id="cName" class="form-control mb-3" placeholder="الاسم الرباعي للعميل" required>
                <div class="row g-2 mb-3">
                    <div class="col-6"><input type="text" id="cID" class="form-control" placeholder="رقم الهوية" required></div>
                    <div class="col-6"><input type="text" id="cPhone" class="form-control" placeholder="رقم الجوال" required></div>
                </div>
                <div class="section-title">بيانات الكفيل</div>
                <input type="text" id="gName" class="form-control mb-3" placeholder="الاسم الرباعي للكفيل">
                <div class="row g-2 mb-3">
                    <div class="col-6"><input type="text" id="gID" class="form-control" placeholder="هوية الكفيل"></div>
                    <div class="col-6"><input type="text" id="gPhone" class="form-control" placeholder="جوال الكفيل"></div>
                </div>
                <div class="section-title">الخطة المالية</div>
                <label class="small text-dim">سعر الشراء (التكلفة)</label>
                <input type="number" id="costAmount" class="form-control mb-3" required>
                <div class="row g-2 mb-3">
                    <div class="col-6"><label class="small text-dim">مبلغ البيع</label><input type="number" id="amount" class="form-control" required></div>
                    <div class="col-6"><label class="small text-dim">الأشهر</label><input type="number" id="instCount" class="form-control" required></div>
                </div>
                <label class="small text-dim">تاريخ أول قسط</label>
                <input type="date" id="startDate" class="form-control mb-4" required>
                <button type="submit" class="btn btn-action">حفظ العقد سحابياً ✅</button>
            </form>
        </div>
    </section>

    <section id="detailsSection" class="p-3" style="display:none;">
        <div class="d-flex justify-content-between mb-4">
            <button class="btn btn-dark rounded-circle" onclick="showSection('home')"><i class="bi bi-chevron-right"></i></button>
            <h6 class="mt-2">كشف الحساب</h6>
            <button class="btn btn-sm btn-light" onclick="downloadPDF()">PDF</button>
        </div>
        <div id="pdfArea"><div id="clientDetailsContent"></div></div>
    </section>

    <div class="bottom-nav">
        <div class="nav-item active" id="nav-home" onclick="showSection('home')"><i class="bi bi-house-door-fill fs-3 d-block"></i>الرئيسية</div>
        <div class="nav-item" id="nav-add" onclick="showSection('addClient')"><i class="bi bi-plus-square-fill fs-3 d-block"></i>إضافة</div>
        <div class="nav-item" onclick="logout()"><i class="bi bi-box-arrow-right fs-3 d-block"></i>خروج</div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getFirestore, collection, addDoc, doc, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

    // بياناتك البرمجية
    const firebaseConfig = {
        apiKey: "AIzaSyCsF-OsbE075c0lwhhcOj6GIHdUZAfCHCU",
        authDomain: "myinstallmentsystem.firebaseapp.com",
        projectId: "myinstallmentsystem",
        storageBucket: "myinstallmentsystem.firebasestorage.app",
        messagingSenderId: "1073933519716",
        appId: "1:1073933519716:web:caac200c07e0356f81c871"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    // وظائف الدخول (بناءً على تفعيلك في الصورة)
    window.loginWithGoogle = () => signInWithPopup(auth, provider);
    window.loginWithEmail = () => {
        const email = document.getElementById('userEmail').value;
        const pass = document.getElementById('userPass').value;
        signInWithEmailAndPassword(auth, email, pass).catch(e => alert("خطأ: تأكد من الإيميل وكلمة المرور"));
    };

    onAuthStateChanged(auth, (user) => {
        if (user) {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            startListening();
        } else {
            document.getElementById('loginPage').style.display = 'block';
            document.getElementById('mainContent').style.display = 'none';
        }
    });

    let clients = [];
    function startListening() {
        onSnapshot(collection(db, "clients"), (s) => {
            clients = s.docs.map(d => ({ id: d.id, ...d.data() }));
            renderHome();
        });
    }

    window.showSection = (id) => {
        ['homeSection', 'addClientSection', 'detailsSection'].forEach(s => document.getElementById(s).style.display = 'none');
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        document.getElementById(id + 'Section').style.display = 'block';
        if(document.getElementById('nav-' + id)) document.getElementById('nav-' + id).classList.add('active');
    };

    document.getElementById('clientForm').onsubmit = async function(e) {
        e.preventDefault();
        const amount = parseFloat(document.getElementById('amount').value);
        const count = parseInt(document.getElementById('instCount').value);
        const date = new Date(document.getElementById('startDate').value);
        let insts = [];
        for(let i=0; i<count; i++) {
            let d = new Date(date); d.setMonth(d.getMonth() + i);
            insts.push({ dueDate: d.toISOString().split('T')[0], amount: (amount / count).toFixed(2), status: 'غير مدفوع' });
        }
        await addDoc(collection(db, "clients"), {
            name: document.getElementById('cName').value, idNum: document.getElementById('cID').value,
            phone: document.getElementById('cPhone').value, gName: document.getElementById('gName').value,
            gID: document.getElementById('gID').value, gPhone: document.getElementById('gPhone').value,
            cost: document.getElementById('costAmount').value, total: amount, installments: insts
        });
        alert('تم الحفظ سحابياً بنجاح ✅'); this.reset(); showSection('home');
    };

    function renderHome() {
        const list = document.getElementById('clientsList'); list.innerHTML = '';
        let total = 0;
        clients.forEach(c => {
            total += parseFloat(c.total);
            list.innerHTML += `<div class="client-row">
                <div><h6 class="mb-0 fw-bold">${c.name}</h6><small class="text-dim">المبلغ الإجمالي: ${parseFloat(c.total).toLocaleString()} ر.س</small></div>
                <button class="btn btn-sm btn-outline-info" onclick="viewClient('${c.id}')">عرض</button>
            </div>`;
        });
        document.getElementById('totalInvestment').innerText = total.toLocaleString() + " ر.س";
        document.getElementById('clientsCount').innerText = clients.length;
    }

    window.viewClient = (id) => {
        const c = clients.find(x => x.id === id);
        let html = `<div class="stat-card">
            <h5 class="fw-bold">${c.name}</h5>
            <p class="small text-dim">الهوية: ${c.idNum} | الجوال: ${c.phone}</p>
            <table class="table table-dark table-borderless small mt-3">
                <thead><tr><th>التاريخ</th><th>الحالة</th><th>تذكير</th></tr></thead>
                <tbody>`;
        c.installments.forEach((inst, idx) => {
            html += `<tr><td>${inst.dueDate}</td>
                <td onclick="togglePayment('${id}', ${idx})" style="cursor:pointer">
                    <span class="${inst.status === 'مدفوع' ? 'text-success' : 'text-danger'} fw-bold">${inst.status}</span>
                </td>
                <td><i class="bi bi-whatsapp text-success fs-5" onclick="sendWA('${c.phone}')"></i></td></tr>`;
        });
        document.getElementById('clientDetailsContent').innerHTML = html + `</tbody></table></div>`;
        showSection('details');
    };

    window.sendWA = (phone) => {
        let p = phone.startsWith('05') ? '966' + phone.substring(1) : phone;
        const msg = `السلام عليكم ورحمة الله وبركاته \n\n نود تذكيرك بالقسط الشهري \n وجزاك الله خير`;
        window.open(`https://wa.me/${p}?text=${encodeURIComponent(msg)}`, '_blank');
    };

    window.togglePayment = async (id, idx) => {
        const c = clients.find(x => x.id === id);
        c.installments[idx].status = c.installments[idx].status === 'مدفوع' ? 'غير مدفوع' : 'مدفوع';
        await updateDoc(doc(db, "clients", id), { installments: c.installments });
        viewClient(id);
    };

    window.logout = () => signOut(auth);
    window.downloadPDF = () => html2pdf().from(document.getElementById('pdfArea')).save('Statement.pdf');
</script>
</body>
</html>
